<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>METAR Decoder</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Helvetica Neue", Arial, sans-serif;
        line-height: 1.5;
      }

      body {
        margin: 0;
        padding: 40px 20px;
        background: #f5f7fb;
        color: #1c2333;
      }

      .container {
        max-width: 760px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 20px 40px rgba(23, 34, 56, 0.08);
      }

      h1 {
        margin: 0 0 8px;
        font-size: 2.2rem;
      }

      p {
        margin: 0 0 24px;
        color: #4b5668;
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
      }

      .fetch-row {
        margin-bottom: 12px;
      }

      .fetch-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      input[type="text"] {
        flex: 1;
        min-width: 200px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d6dbe5;
        font-size: 1rem;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        padding: 14px 16px;
        border-radius: 10px;
        border: 1px solid #d6dbe5;
        font-size: 1rem;
        resize: vertical;
      }

      .hint {
        margin: 8px 0 0;
        font-size: 0.9rem;
        color: #69748a;
      }

      button {
        margin-top: 16px;
        background: #246bff;
        color: #ffffff;
        border: none;
        padding: 12px 20px;
        font-size: 1rem;
        border-radius: 10px;
        cursor: pointer;
      }

      button:hover {
        background: #1c55cc;
      }

      button[disabled] {
        cursor: not-allowed;
        opacity: 0.7;
      }

      .error {
        margin: 12px 0 0;
        color: #b42318;
        font-weight: 600;
      }

      .results {
        margin-top: 24px;
        background: #f8f9fc;
        border-radius: 10px;
        padding: 16px 20px;
      }

      .results h2 {
        margin: 0 0 12px;
        font-size: 1.2rem;
      }

      .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px 24px;
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        background: #ffffff;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #e1e6f0;
      }

      .result-item span:first-child {
        font-weight: 600;
      }

      .result-item span:last-child {
        color: #1c2333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>METAR Decoder</h1>
      <p>Paste a METAR below and decode the basic weather elements.</p>

      <label for="metar-input">METAR</label>
      <div class="fetch-row">
        <div class="fetch-controls">
          <input
            id="station-input"
            type="text"
            placeholder="PANC or KJFK"
            aria-label="Station"
          />
          <button id="fetch-button" type="button">Fetch METAR</button>
        </div>
        <p id="station-hint" class="hint" role="status" aria-live="polite"></p>
      </div>
      <textarea id="metar-input">PANC 121653Z 14012KT 10SM SCT035 BKN070 04/M02 A3005</textarea>
      <button id="decode-button" type="button">Decode</button>
      <p id="error-message" class="error" role="alert" aria-live="assertive"></p>

      <div class="results" aria-live="polite">
        <h2>Decoded Summary</h2>
        <div class="result-grid" id="decoded-output"></div>
      </div>
    </div>

    <script>
      const fields = [
        { key: "station", label: "Station" },
        { key: "time", label: "Time group" },
        { key: "wind", label: "Wind" },
        { key: "visibility", label: "Visibility" },
        { key: "clouds", label: "Clouds" },
        { key: "tempDew", label: "Temperature / Dewpoint" },
        { key: "altimeter", label: "Altimeter" }
      ];

      const output = document.getElementById("decoded-output");
      const button = document.getElementById("decode-button");
      const input = document.getElementById("metar-input");
      const fetchButton = document.getElementById("fetch-button");
      const stationInput = document.getElementById("station-input");
      const stationHint = document.getElementById("station-hint");
      const errorMessage = document.getElementById("error-message");

      const PROXY_BASE_URL = "https://YOUR-WORKER.your-subdomain.workers.dev/";

      async function fetchMetarForStation(station) {
        const s = station.trim().toUpperCase();
        if (!s) {
          throw new Error("Enter a station (e.g., PANC or KJFK).");
        }

        const proxyUrl = `${PROXY_BASE_URL}?ids=${encodeURIComponent(s)}`;

        const r = await fetch(proxyUrl);
        if (!r.ok) {
          throw new Error(`Fetch failed (${r.status})`);
        }
        const data = await r.json();

        return data.metar;
      }

      const isTimeGroup = (token) => /^\d{6}Z$/.test(token);
      const isWind = (token) => /^(\d{3}|VRB)\d{2,3}KT$/.test(token);
      const isVisibility = (token) => /^(\d+SM|\d+\/\d+SM)$/.test(token);
      const isCloud = (token) => /^(FEW|SCT|BKN|OVC|CLR|SKC|NSC)\d{0,3}/.test(token);
      const isTempDew = (token) => /^(M?\d{2})\/(M?\d{2})$/.test(token);
      const isAltimeter = (token) => /^A\d{4}$/.test(token);

      const formatTemp = (value) =>
        value.startsWith("M") ? `-${value.slice(1)}` : value;

      const decodeMetar = (rawMetar) => {
        const tokens = rawMetar.trim().replace(/\s+/g, " ").split(" ");
        const decoded = {
          station: "N/A",
          time: "N/A",
          wind: "N/A",
          visibility: "N/A",
          clouds: "N/A",
          tempDew: "N/A",
          altimeter: "N/A"
        };

        if (tokens[0]) {
          decoded.station = tokens[0];
        }

        for (const token of tokens) {
          if (decoded.time === "N/A" && isTimeGroup(token)) {
            decoded.time = token;
          } else if (decoded.wind === "N/A" && isWind(token)) {
            decoded.wind = token;
          } else if (decoded.visibility === "N/A" && isVisibility(token)) {
            decoded.visibility = token;
          } else if (decoded.tempDew === "N/A" && isTempDew(token)) {
            const [temp, dew] = token.split("/");
            decoded.tempDew = `${formatTemp(temp)}°C / ${formatTemp(dew)}°C`;
          } else if (decoded.altimeter === "N/A" && isAltimeter(token)) {
            decoded.altimeter = `${token.slice(1, 3)}.${token.slice(3)} inHg`;
          }
        }

        const cloudTokens = tokens.filter((token) => isCloud(token));
        if (cloudTokens.length > 0) {
          decoded.clouds = cloudTokens.join(", ");
        }

        return decoded;
      };

      const render = (decoded) => {
        output.innerHTML = "";
        fields.forEach((field) => {
          const item = document.createElement("div");
          item.className = "result-item";
          const label = document.createElement("span");
          label.textContent = field.label;
          const value = document.createElement("span");
          value.textContent = decoded[field.key] || "N/A";
          item.append(label, value);
          output.appendChild(item);
        });
      };

      const setError = (message) => {
        errorMessage.textContent = message;
      };

      const updateStationHint = (value) => {
        const trimmed = value.trim();
        if (trimmed.length === 3) {
          stationHint.textContent = "Prefer 4-letter ICAO (e.g., PANC).";
        } else {
          stationHint.textContent = "";
        }
      };

      button.addEventListener("click", () => {
        setError("");
        const decoded = decodeMetar(input.value);
        render(decoded);
      });

      fetchButton.addEventListener("click", async () => {
        setError("");
        fetchButton.disabled = true;
        fetchButton.textContent = "Fetching...";
        try {
          const metar = await fetchMetarForStation(stationInput.value);
          input.value = metar;
          const decoded = decodeMetar(metar);
          render(decoded);
        } catch (error) {
          setError(error.message || "Unable to fetch METAR.");
        } finally {
          fetchButton.disabled = false;
          fetchButton.textContent = "Fetch METAR";
        }
      });

      stationInput.addEventListener("input", (event) => {
        updateStationHint(event.target.value);
      });

      updateStationHint(stationInput.value);
      render(decodeMetar(input.value));
    </script>
  </body>
</html>
